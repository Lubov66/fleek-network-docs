"use strict";(self.webpackChunkdocta=self.webpackChunkdocta||[]).push([[7706],{9747:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>c,metadata:()=>d,toc:()=>a});var n=t(5893),r=t(1151),i=t(3872);const c={title:"User service",slug:"user-service",hide_title:!0,tags:["references","help","user service","unit","systemctl","systemd"]},l=void 0,d={id:"Systemd/user-service",title:"User service",description:"A user should have the ability to run a Systemd user service unit without having to use sudo to control it.",source:"@site/references/Systemd/user-service.md",sourceDirName:"Systemd",slug:"/Systemd/user-service",permalink:"/references/Systemd/user-service",draft:!1,unlisted:!1,editUrl:"https://github.com/fleek-network/fleek-network-docs/edit/main/references/Systemd/user-service.md",tags:[{label:"references",permalink:"/references/tags/references"},{label:"help",permalink:"/references/tags/help"},{label:"user service",permalink:"/references/tags/user-service"},{label:"unit",permalink:"/references/tags/unit"},{label:"systemctl",permalink:"/references/tags/systemctl"},{label:"systemd",permalink:"/references/tags/systemd"}],version:"current",lastUpdatedAt:1716972050,formattedLastUpdatedAt:"May 29, 2024",frontMatter:{title:"User service",slug:"user-service",hide_title:!0,tags:["references","help","user service","unit","systemctl","systemd"]},sidebar:"defaultSidebar",previous:{title:"Shutting down persistance",permalink:"/references/Systemd/shutting-down-persistance"}},o={},a=[{value:"Check <code>--user</code> support",id:"check---user-support",level:2},{value:"Put the service unit in the user service",id:"put-the-service-unit-in-the-user-service",level:2},{value:"Reload daemon",id:"reload-daemon",level:2},{value:"Systemd service control as <code>--user</code>",id:"systemd-service-control-as---user",level:2},{value:"Problem statement",id:"problem-statement",level:2}];function h(e){const s={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(s.p,{children:["A user should have the ability to run a Systemd user service unit without having to use ",(0,n.jsx)(s.code,{children:"sudo"})," to control it."]}),"\n",(0,n.jsxs)(s.h2,{id:"check---user-support",children:["Check ",(0,n.jsx)(s.code,{children:"--user"})," support"]}),"\n",(0,n.jsxs)(s.p,{children:["Use the ",(0,n.jsx)(s.code,{children:"--user"})," flag when getting the list of unit files."]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user list-unit-files\n"})}),"\n",(0,n.jsx)(s.p,{children:"It should return a list of unit files."}),"\n",(0,n.jsx)(s.h2,{id:"put-the-service-unit-in-the-user-service",children:"Put the service unit in the user service"}),"\n",(0,n.jsx)(s.p,{children:"Create the Systemd user units directory:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"sudo mkdir -p /etc/systemd/system/user\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Move the ",(0,n.jsx)(s.code,{children:"lightning.service"})," to the system user unit service directory:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"mv /etc/systemd/system/lightning.service /etc/systemd/system/user/lightning.service\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Check the ",(0,n.jsx)(s.strong,{children:"Load path when running in user mode (--user)"})," in ",(0,n.jsx)(s.a,{href:"https://www.freedesktop.org/software/systemd/man/systemd.unit.html",children:"Systemd unit"})," for other alternative user paths, or to understand how it works to customize your server accordingly."]}),"\n",(0,n.jsx)(s.h2,{id:"reload-daemon",children:"Reload daemon"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"sudo systemctl daemon-reload\n"})}),"\n",(0,n.jsxs)(s.h2,{id:"systemd-service-control-as---user",children:["Systemd service control as ",(0,n.jsx)(s.code,{children:"--user"})]}),"\n",(0,n.jsx)(s.p,{children:"Reload the Systemctl daemon by executing the command:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user daemon-reload\n"})}),"\n",(0,n.jsx)(s.p,{children:"Enable the service for starting up on system boot:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user enable lightning.service\n"})}),"\n",(0,n.jsx)(s.p,{children:"Start the service by:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user start lightning\n"})}),"\n",(0,n.jsx)(s.p,{children:"Stop the service by:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user stop lightning\n"})}),"\n",(0,n.jsx)(s.p,{children:"Restart the service by:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user restart lightning\n"})}),"\n",(0,n.jsx)(s.p,{children:"Check the service status by:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user status lightning.service\n"})}),"\n",(0,n.jsx)(s.h2,{id:"problem-statement",children:"Problem statement"}),"\n",(0,n.jsxs)(s.p,{children:["On tests done in a DigitalOcean Ubuntu 22.x, we had set up user-level services which were operated with ",(0,n.jsx)(s.code,{children:"--user"}),". When the commands were executed as ",(0,n.jsx)(s.code,{children:"--user"})," it failed with:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"Failed to connect to bus: Operation not permitted (consider using --machine=<user>@.host --user to connect to bus of other user)\n"})}),"\n",(0,n.jsx)(s.p,{children:"The user should be able to operate as user, it shouldn't be required to connect on behalf of other users. This means that even for a simple command, such as to retrieve the list of unit files:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"systemctl --user list-unit-files\n"})}),"\n",(0,n.jsx)(s.p,{children:"We'd get the error:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"Failed to connect to bus: Operation not permitted (consider using --machine=<user>@.host --user to connect to bus of other user)\n"})}),"\n",(0,n.jsxs)(s.p,{children:["For any of the supported user unit locations e.g. $HOME/.config/systemd/user as documented in ",(0,n.jsx)(s.a,{href:"https://www.freedesktop.org/software/systemd/man/systemd.unit.html",children:"Systemd unit documentation"}),", the result is the error above."]}),"\n",(0,n.jsxs)(s.p,{children:["This is related to the load paths when running in user mode (--user), as described in the discussion ",(0,n.jsx)(s.a,{href:"https://unix.stackexchange.com/questions/224992/where-do-i-put-my-systemd-unit-file/367237#367237",children:"here"}),"."]}),"\n",(0,n.jsx)(s.p,{children:(0,n.jsx)(s.strong,{children:"User-dependent"})}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"$XDG_CONFIG_HOME/systemd/user"})," User configuration (only used when $XDG_CONFIG_HOME is set)"]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"$HOME/.config/systemd/user"})," User configuration (only used when $XDG_CONFIG_HOME is not set)"]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"$XDG_RUNTIME_DIR/systemd/user"})," Runtime units (only used when $XDG_RUNTIME_DIR is set)"]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"$XDG_DATA_HOME/systemd/user"})," Units of packages that have been installed in the home directory (only used when $XDG_DATA_HOME is set)"]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"$HOME/.local/share/systemd/user"})," Units of packages that have been installed in the home directory (only used when $XDG_DATA_HOME is not set)"]}),"\n",(0,n.jsxs)(s.p,{children:["For example, if we check the ",(0,n.jsx)(s.code,{children:"$XDG_RUNTIME_DIR"})," in a DigitalOcean box, we get the following output:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"/run/user/0\n"})}),"\n",(0,n.jsx)(s.p,{children:"For this reason and to provide support for a wider audience of users and systems, we've stuck to sudo to execute the service, but this should not be a requirement and is not recommended."}),"\n",(0,n.jsx)(i.Z,{name:"Helder Oliveira",image:"https://github.com/heldrida.png",title:"Software Developer + DX",url:"https://github.com/heldrida"})]})}function u(e={}){const{wrapper:s}={...(0,r.a)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},3872:(e,s,t)=>{t.d(s,{Z:()=>r});t(7294);var n=t(5893);const r=e=>{let{image:s,name:t,title:r,url:i,communityMember:c=!1}=e;return(0,n.jsx)("section",{className:"author_card",children:(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"avatar",children:(0,n.jsx)("a",{href:i,target:"_blank",alt:t,children:(0,n.jsx)("img",{src:s,alt:t})})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("span",{className:"name",children:(0,n.jsx)("a",{href:i,target:"_blank",alt:t,children:t})}),(0,n.jsx)("span",{className:"title",children:r}),(0,n.jsxs)("span",{className:"discord",children:[c?"Join our community on":"Got questions? Find us on"," ",(0,n.jsx)("a",{href:"https://discord.gg/fleek",target:"_blank",children:"discord!"})]})]})]})})}},1151:(e,s,t)=>{t.d(s,{Z:()=>l,a:()=>c});var n=t(7294);const r={},i=n.createContext(r);function c(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);